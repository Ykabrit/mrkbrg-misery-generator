var Jn=Object.defineProperty;var jn=(s,t,e)=>t in s?Jn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var C=(s,t,e)=>jn(s,typeof t!="symbol"?t+"":t,e);import{e as kn}from"./mathjs-CscKSDzz.js";/**
 * @dice-roller/rpg-dice-roller - An advanced JS based dice roller that can roll various types of dice and modifiers, along with mathematical equations.
 * 
 * @version 5.5.0
 * @license MIT
 * @author GreenImp Media <info@greenimp.co.uk> (https://greenimp.co.uk)
 * @link https://dice-roller.github.io/documentation
 */class wt extends TypeError{constructor(t){super(`Operator "${t}" is invalid`),TypeError.captureStackTrace&&TypeError.captureStackTrace(this,wt),this.name="CompareOperatorError",this.operator=t}}class ke extends Error{constructor(t){super(`Invalid data format: ${t}`),Error.captureStackTrace&&Error.captureStackTrace(this,ke),this.name="ImportError",this.data=t}}class ce extends Error{constructor(t,e=null){super(`Die "${t}" must have more than 1 possible value to ${e||"do this action"}`),Error.captureStackTrace&&Error.captureStackTrace(this,ce),this.name="DieActionValueError",this.action=e,this.die=t}}class Fe extends Error{constructor(t){super(`Notation "${t}" is invalid`),Error.captureStackTrace&&Error.captureStackTrace(this,Fe),this.name="NotationError",this.notation=t}}class I extends Error{constructor(t=null){super(`Missing argument${t?` "${t}"`:""}`),Error.captureStackTrace&&Error.captureStackTrace(this,I),this.argumentName=t}}const Dn=(s,t,e)=>{const o=Number(s),f=Number(t);let u;if(Number.isNaN(o)||Number.isNaN(f))return!1;switch(e){case"=":case"==":u=o===f;break;case"<":u=o<f;break;case">":u=o>f;break;case"<=":u=o<=f;break;case">=":u=o>=f;break;case"!":case"!=":case"<>":u=o!==f;break;default:u=!1;break}return u},Lr=s=>kn(s),E=s=>typeof s!="number"&&typeof s!="string"?!1:!Number.isNaN(s)&&Number.isFinite(Number(s)),We=s=>{if(!E(s))return!1;const t=Number(s);return t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER},Vn=s=>Array.isArray(s)?s.reduce((t,e)=>t+(E(e)?parseFloat(`${e}`):0),0):0,qn=(s,t=0)=>parseFloat(parseFloat(`${s}`).toFixed(t||0)),A=9007199254740992,oe=A-1,Pe=-1>>>0,M=Pe+1,D=M/2,Ze=D-1,he=1<<21,Z=he-1;function St(s){return s.next()|0}function U(s,t){return t===0?s:e=>s(e)+t}function gt(s){const t=s.next()|0,e=s.next()>>>0;return(t&Z)*M+e+(t&he?-A:0)}function Br(s){for(;;){const t=s.next()|0;if(t&4194304){if((t&8388607)===4194304&&!(s.next()|0))return A}else{const e=s.next()>>>0;return(t&Z)*M+e+(t&he?-A:0)}}}function Ur(s){return s.next()>>>0}function De(s){const t=s.next()&Z,e=s.next()>>>0;return t*M+e}function xt(s){for(;;){const t=s.next()|0;if(t&he){if(!(t&Z)&&!(s.next()|0))return A}else{const e=s.next()>>>0;return(t&Z)*M+e}}}function Gr(s){return(s+1&s)===0}function Ln(s){return t=>t.next()&s}function Bn(s){const t=s+1,e=t*Math.floor(M/t);return o=>{let f=0;do f=o.next()>>>0;while(f>=e);return f%t}}function Un(s){return Gr(s)?Ln(s):Bn(s)}function Gn(s){return(s|0)===0}function _n(s){return t=>{const e=t.next()&s,o=t.next()>>>0;return e*M+o}}function Wn(s){const t=s*Math.floor(A/s);return e=>{let o=0;do{const f=e.next()&Z,u=e.next()>>>0;o=f*M+u}while(o>=t);return o%s}}function Zn(s){const t=s+1;if(Gn(t)){const e=(t/M|0)-1;if(Gr(e))return _n(e)}return Wn(t)}function cr(s,t){return e=>{let o=0;do{const f=e.next()|0,u=e.next()>>>0;o=(f&Z)*M+u+(f&he?-A:0)}while(o<s||o>t);return o}}function X(s,t){if(s=Math.floor(s),t=Math.floor(t),s<-A||!isFinite(s))throw new RangeError(`Expected min to be at least ${-A}`);if(t>A||!isFinite(t))throw new RangeError(`Expected max to be at most ${A}`);const e=t-s;return e<=0||!isFinite(e)?()=>s:e===Pe?s===0?Ur:U(St,s+D):e<Pe?U(Un(e),s):e===oe?U(De,s):e<oe?U(Zn(e),s):t-1-s===oe?U(xt,s):s===-A&&t===A?Br:s===-A&&t===oe?gt:s===-oe&&t===A?U(gt,1):t===A?U(cr(s-1,t-1),1):cr(s,t)}function Xn(s){return(s.next()&1)===1}function mt(s,t){return e=>s(e)<t}function Hn(s){if(s<=0)return()=>!1;if(s>=1)return()=>!0;{const t=s*M;return t%1===0?mt(St,t-D|0):mt(De,Math.round(s*A))}}function Yn(s,t){return t==null?s==null?Xn:Hn(s):s<=0?()=>!1:s>=t?()=>!0:mt(X(0,t-1),s)}function zn(s,t){const e=X(+s,+t);return o=>new Date(e(o))}function _r(s){return X(1,s)}function Kn(s,t){const e=_r(s);return o=>{const f=[];for(let u=0;u<t;++u)f.push(e(o));return f}}const Qn="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-";function Et(s=Qn){const t=s.length;if(!t)throw new Error("Expected pool not to be an empty string");const e=X(0,t-1);return(o,f)=>{let u="";for(let m=0;m<f;++m){const $=e(o);u+=s.charAt($)}return u}}const Wr="0123456789abcdef",eo=Et(Wr),to=Et(Wr.toUpperCase());function ro(s){return s?to:eo}function hr(s,t){return s<0?Math.max(s+t,0):Math.min(s,t)}function pr(s){const t=+s;return t<0?Math.ceil(t):Math.floor(t)}function so(s,t,e,o){const f=t.length;if(f===0)throw new RangeError("Cannot pick from an empty array");const u=e==null?0:hr(pr(e),f),m=o===void 0?f:hr(pr(o),f);if(u>=m)throw new RangeError(`Cannot pick between bounds ${u} and ${m}`);const $=X(u,m-1);return t[$(s)]}function io(s,t){return t===1?s:t===0?()=>0:e=>s(e)*t}function Zr(s){return De(s)/A}function Xr(s){return xt(s)/A}function no(s,t,e=!1){if(isFinite(s)){if(!isFinite(t))throw new RangeError("Expected max to be a finite number")}else throw new RangeError("Expected min to be a finite number");return U(io(e?Xr:Zr,t-s),s)}const oo=Array.prototype.slice;function dt(s,t,e=0){const o=t.length;if(o)for(let f=o-1>>>0;f>e;--f){const m=X(0,f)(s);if(f!==m){const $=t[f];t[f]=t[m],t[m]=$}}return t}function ao(s,t,e){if(e<0||e>t.length||!isFinite(e))throw new RangeError("Expected sampleSize to be within 0 and the length of the population");if(e===0)return[];const o=oo.call(t),f=o.length;if(f===e)return dt(s,o,0);const u=f-e;return dt(s,o,u-1).slice(u)}const lo=(()=>{try{if("x".repeat(3)==="xxx")return(s,t)=>s.repeat(t)}catch{}return(s,t)=>{let e="";for(;t>0;)t&1&&(e+=s),t>>=1,s+=s;return e}})();function K(s,t){return lo("0",t-s.length)+s}function fo(s){const t=s.next()>>>0,e=s.next()|0,o=s.next()|0,f=s.next()>>>0;return K(t.toString(16),8)+"-"+K((e&65535).toString(16),4)+"-"+K((e>>4&4095|16384).toString(16),4)+"-"+K((o&16383|32768).toString(16),4)+"-"+K((o>>4&65535).toString(16),4)+K(f.toString(16),8)}const ee={next(){return Math.random()*M|0}};class uo{constructor(t=ee){this.engine=t}int32(){return St(this.engine)}uint32(){return Ur(this.engine)}uint53(){return De(this.engine)}uint53Full(){return xt(this.engine)}int53(){return gt(this.engine)}int53Full(){return Br(this.engine)}integer(t,e){return X(t,e)(this.engine)}realZeroToOneInclusive(){return Xr(this.engine)}realZeroToOneExclusive(){return Zr(this.engine)}real(t,e,o=!1){return no(t,e,o)(this.engine)}bool(t,e){return Yn(t,e)(this.engine)}pick(t,e,o){return so(this.engine,t,e,o)}shuffle(t){return dt(this.engine,t)}sample(t,e){return ao(this.engine,t,e)}die(t){return _r(t)(this.engine)}dice(t,e){return Kn(t,e)(this.engine)}uuid4(){return fo(this.engine)}string(t,e){return Et(e)(this.engine,t)}hex(t,e){return ro(e)(this.engine,t)}date(t,e){return zn(t,e)(this.engine)}}const Hr=(()=>{try{const s=new ArrayBuffer(4),t=new Int32Array(s);if(t[0]=D,t[0]===-D)return Int32Array}catch{}return Array})();let Oe=null;const $t=128;let Xe=$t;const co={next(){return Xe>=$t&&(Oe===null&&(Oe=new Hr($t)),crypto.getRandomValues(Oe),Xe=0),Oe[Xe++]|0}};function ho(s=ee,t=16){const e=[];e.push(new Date().getTime()|0);for(let o=1;o<t;++o)e[o]=s.next()|0;return e}const yt=(()=>{try{if(Math.imul(Pe,5)===-5)return Math.imul}catch{}const s=65535;return(t,e)=>{const o=t>>>16&s,f=t&s,u=e>>>16&s,m=e&s;return f*m+(o*m+f*u<<16>>>0)|0}})(),j=624,G=j-1,bt=397,gr=j-bt,He=2567483615;class ue{constructor(){this.data=new Hr(j),this.index=0,this.uses=0}static seed(t){return new ue().seed(t)}static seedWithArray(t){return new ue().seedWithArray(t)}static autoSeed(){return ue.seedWithArray(ho())}next(){(this.index|0)>=j&&(Ye(this.data),this.index=0);const t=this.data[this.index];return this.index=this.index+1|0,this.uses+=1,po(t)|0}getUseCount(){return this.uses}discard(t){if(t<=0)return this;for(this.uses+=t,(this.index|0)>=j&&(Ye(this.data),this.index=0);t+this.index>j;)t-=j-this.index,Ye(this.data),this.index=0;return this.index=this.index+t|0,this}seed(t){let e=0;this.data[0]=e=t|0;for(let o=1;o<j;o=o+1|0)this.data[o]=e=yt(e^e>>>30,1812433253)+o|0;return this.index=j,this.uses=0,this}seedWithArray(t){return this.seed(19650218),go(this.data,t),this}}function Ye(s){let t=0,e=0;for(;(t|0)<gr;t=t+1|0)e=s[t]&D|s[t+1|0]&Ze,s[t]=s[t+bt|0]^e>>>1^(e&1?He:0);for(;(t|0)<G;t=t+1|0)e=s[t]&D|s[t+1|0]&Ze,s[t]=s[t-gr|0]^e>>>1^(e&1?He:0);e=s[G]&D|s[0]&Ze,s[G]=s[bt-1]^e>>>1^(e&1?He:0)}function po(s){return s^=s>>>11,s^=s<<7&2636928640,s^=s<<15&4022730752,s^s>>>18}function go(s,t){let e=1,o=0;const f=t.length;let u=Math.max(f,j)|0,m=s[0]|0;for(;(u|0)>0;--u)s[e]=m=(s[e]^yt(m^m>>>30,1664525))+(t[o]|0)+(o|0)|0,e=e+1|0,++o,(e|0)>G&&(s[0]=s[G],e=1),o>=f&&(o=0);for(u=G;(u|0)>0;--u)s[e]=m=(s[e]^yt(m^m>>>30,1566083941))-e|0,e=e+1|0,(e|0)>G&&(s[0]=s[G],e=1);s[0]=D}let mr=null;const vt=128;let ze=vt;const mo={next(){return ze>=vt&&(mr=new Int32Array(new Int8Array(require("crypto").randomBytes(4*vt)).buffer),ze=0),mr[ze++]|0}},ae=Symbol("engine"),Ke=Symbol("random"),$o={range:[],next(){return this.range[1]-this.range[0]}},yo={next(){return 0}},dr={browserCrypto:co,nodeCrypto:mo,MersenneTwister19937:ue,nativeMath:ee,min:yo,max:$o};class bo{constructor(t=ee){this.engine=t||ee}get engine(){return this[ae]}set engine(t){if(t&&typeof t.next!="function")throw new TypeError("engine must have function `next()`");this[ae]=t||ee,this[Ke]=new uo(this[ae])}integer(t,e){return this[ae].range=[t,e],this[Ke].integer(t,e)}real(t,e,o=!1){return this[ae].range=[t,e],this[Ke].real(t,e,o)}}const te=new bo,$r=Symbol("text"),yr=Symbol("type");class P{constructor(t,e=this.constructor.types.INLINE){this.text=t,this.type=e}get text(){return this[$r]}set text(t){if(typeof t=="object")throw new TypeError("Description text is invalid");if(!t&&t!==0||`${t}`.trim()==="")throw new TypeError("Description text cannot be empty");this[$r]=`${t}`.trim()}get type(){return this[yr]}set type(t){const e=Object.values(this.constructor.types);if(typeof t!="string")throw new TypeError("Description type must be a string");if(!e.includes(t))throw new RangeError(`Description type must be one of; ${e.join(", ")}`);this[yr]=t}toJSON(){const{text:t,type:e}=this;return{text:t,type:e}}toString(){return this.type===this.constructor.types.INLINE?`# ${this.text}`:`[${this.text}]`}}C(P,"types",{MULTILINE:"multiline",INLINE:"inline"});const Re=Symbol("description");class Yr{constructor(t=null){this.description=t}get description(){return this[Re]||null}set description(t){if(!t&&t!==0)this[Re]=null;else if(t instanceof P)this[Re]=t;else if(typeof t=="string")this[Re]=new P(t);else throw new TypeError(`description must be of type Description, string or null. Received ${typeof t}`)}toJSON(){const{description:t}=this;return{description:t}}toString(){return this.description?`${this.description}`:""}}class V{constructor(){this.order=this.constructor.order}get name(){return"modifier"}get notation(){return""}get maxIterations(){return 1e3}defaults(t){return{}}useDefaultsIfNeeded(t){Object.entries(this.defaults(t)).forEach(([e,o])=>{typeof this[e]>"u"&&(this[e]=o)})}run(t,e){return this.useDefaultsIfNeeded(e),t}toJSON(){const{notation:t,name:e}=this;return{name:e,notation:t,type:"modifier"}}toString(){return this.notation}}C(V,"order",999);const vo={compound:"!",explode:"!","critical-failure":"__","critical-success":"**",drop:"d",max:"v",min:"^",penetrate:"p","re-roll":"r","re-roll-once":"ro","target-failure":"_","target-success":"*",unique:"u","unique-once":"uo"},zr=(...s)=>[...s].reduce((t,e)=>{let o;return e instanceof V?o=e.name:o=e,t+(vo[o]||o)},""),Qe=Symbol("calculation-value"),et=Symbol("modifiers"),le=Symbol("initial-value"),br=Symbol("use-in-total"),tt=Symbol("value");class Je{constructor(t,e=[],o=!0){if(E(t))this[le]=Number(t),this.modifiers=e||[],this.useInTotal=o;else if(t&&typeof t=="object"&&!Array.isArray(t)){const f=E(t.initialValue)?t.initialValue:t.value;if(!E(f))throw new TypeError(`Result value is invalid: ${f}`);this[le]=Number(f),E(t.value)&&Number(t.value)!==this[le]&&(this.value=t.value),E(t.calculationValue)&&parseFloat(`${t.calculationValue}`)!==this.value&&(this.calculationValue=t.calculationValue),this.modifiers=t.modifiers||e||[],this.useInTotal=typeof t.useInTotal=="boolean"?t.useInTotal:o||!1}else throw t===1/0?new RangeError("Result value must be a finite number"):new TypeError(`Result value is invalid: ${t}`)}get calculationValue(){return E(this[Qe])?parseFloat(this[Qe]):this.value}set calculationValue(t){const e=E(t);if(t===1/0)throw new RangeError("Result calculation value must be a finite number");if(t&&!e)throw new TypeError(`Result calculation value is invalid: ${t}`);this[Qe]=e?parseFloat(`${t}`):null}get initialValue(){return this[le]}get modifierFlags(){return zr(...this.modifiers)}get modifiers(){return this[et]}set modifiers(t){if((Array.isArray(t)||t instanceof Set)&&[...t].every(e=>typeof e=="string")){this[et]=new Set([...t]);return}if(!t&&t!==0){this[et]=new Set;return}throw new TypeError(`modifiers must be a Set or array of modifier names: ${t}`)}get useInTotal(){return!!this[br]}set useInTotal(t){this[br]=!!t}get value(){return E(this[tt])?this[tt]:this[le]}set value(t){if(t===1/0)throw new RangeError("Result value must be a finite number");if(!E(t))throw new TypeError(`Result value is invalid: ${t}`);this[tt]=Number(t)}toJSON(){const{calculationValue:t,initialValue:e,modifierFlags:o,modifiers:f,useInTotal:u,value:m}=this;return{calculationValue:t,initialValue:e,modifierFlags:o,modifiers:[...f],type:"result",useInTotal:u,value:m}}toString(){return this.value+this.modifierFlags}}const rt=Symbol("rolls");class k{constructor(t=[]){this.rolls=t}get length(){return this.rolls.length||0}get rolls(){return[...this[rt]]}set rolls(t){if(!t||!Array.isArray(t))throw new TypeError(`rolls must be an array: ${t}`);this[rt]=[],t.forEach(e=>{this.addRoll(e)})}get value(){return this.rolls.reduce((t,e)=>t+(e.useInTotal?e.calculationValue:0),0)}addRoll(t){const e=t instanceof Je?t:new Je(t);this[rt].push(e)}toJSON(){const{rolls:t,value:e}=this;return{rolls:t,type:"roll-results",value:e}}toString(){return`[${this.rolls.join(", ")}]`}}const st=Symbol("modifiers"),vr=Symbol("qty"),wr=Symbol("sides"),Sr=Symbol("min-value"),xr=Symbol("max-value");class se extends Yr{constructor(t,e=1,o=null,f=1,u=null,m=null){if(super(m),!t&&t!==0)throw new I("sides");if(t===1/0)throw new RangeError("numerical sides must be finite number");if(E(t)){if(t<1||!We(t))throw new RangeError("numerical sides must be a positive finite number")}else if(typeof t!="string")throw new TypeError("non-numerical sides must be a string");if(E(e)){if(e<1||e>999)throw new RangeError("qty must be between 1 and 999")}else throw new TypeError("qty must be a positive finite integer");let $=f;if($==null)$=1;else if(E($)){if(!We($))throw new RangeError("min must a finite number")}else throw new TypeError("min must a finite number");if(u&&!E(u))throw new TypeError("max must a finite number");if(u&&!We(u))throw new RangeError("max must a finite number");this[vr]=parseInt(`${e}`,10),this[wr]=t,o&&(this.modifiers=o),this[Sr]=parseInt($,10),this[xr]=u?parseInt(`${u}`,10):t}get average(){return(this.min+this.max)/2}get modifiers(){return this[st]?new Map([...this[st]].sort((t,e)=>t[1].order-e[1].order)):null}set modifiers(t){let e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map(o=>[o.name,o]));else if(typeof t=="object")e=new Map(Object.entries(t));else throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");if(e.size&&[...e.entries()].some(o=>!(o[1]instanceof V)))throw new TypeError("modifiers must only contain Modifier instances");this[st]=e}get max(){return this[xr]}get min(){return this[Sr]}get name(){return"standard"}get notation(){let t=`${this.qty}d${this.sides}`;return this.modifiers&&this.modifiers.size&&(t+=[...this.modifiers.values()].reduce((e,o)=>e+o.notation,"")),t}get qty(){return this[vr]}get sides(){return this[wr]}roll(){const t=new k;for(let e=0;e<this.qty;e++)t.addRoll(this.rollOnce());return(this.modifiers||[]).forEach(e=>{e.run(t,this)}),t}rollOnce(){return new Je(te.integer(this.min,this.max))}toJSON(){const{average:t,max:e,min:o,modifiers:f,name:u,notation:m,qty:$,sides:O}=this;return Object.assign(super.toJSON(),{average:t,max:e,min:o,modifiers:f,name:u,notation:m,qty:$,sides:O,type:"die"})}toString(){return`${this.notation}${this.description?` ${this.description}`:""}`}}class wo extends se{constructor(t=2,e=1,o=null,f=null){let u=t;if(!u&&u!==0)u=2;else if(u!==1&&u!==2)throw new RangeError("nonBlanks must be 1 or 2");super(u,e,o,-1,1,f)}get name(){return"fudge"}get nonBlanks(){return super.sides}get sides(){return`F.${this.nonBlanks}`}rollOnce(){let t=0;if(this.nonBlanks===2)t=te.integer(1,3)-2;else if(this.nonBlanks===1){const e=te.integer(1,6);e===1?t=-1:e===6&&(t=1)}return new Je(t)}}class So extends se{constructor(t=1,e=null,o=!1,f=null){super(100,t,e,null,null,f),this.sidesAsNumber=!!o}get name(){return"percentile"}get sides(){return this.sidesAsNumber?super.sides:"%"}}const Er=Symbol("operator"),Ar=Symbol("value");class je{constructor(t,e){if(t){if(!e&&e!==0)throw new I("value")}else throw new I("operator");this.operator=t,this.value=e}static isValidOperator(t){return typeof t=="string"&&/^(?:[<>!]?=|[<>]|<>)$/.test(t)}set operator(t){if(!this.constructor.isValidOperator(t))throw new wt(t);this[Er]=t}get operator(){return this[Er]}set value(t){if(!E(t))throw new TypeError("value must be a finite number");this[Ar]=Number(t)}get value(){return this[Ar]}isMatch(t){return Dn(t,this.value,this.operator)}toJSON(){const{operator:t,value:e}=this;return{operator:t,type:"compare-point",value:e}}toString(){return`${this.operator}${this.value}`}}const Tr=Symbol("compare-point");class ne extends V{constructor(t){super(),t&&(this.comparePoint=t)}get comparePoint(){return this[Tr]}set comparePoint(t){if(!(t instanceof je))throw new TypeError("comparePoint must be instance of ComparePoint");this[Tr]=t}get name(){return"comparison"}get notation(){return`${this.comparePoint||""}`}defaultComparePoint(t){return{}}defaults(t){const e=this.defaultComparePoint(t);return typeof e=="object"&&e.length===2?{comparePoint:new je(...e)}:{}}isComparePoint(t){return this.comparePoint?this.comparePoint.isMatch(t):!1}toJSON(){const{comparePoint:t}=this;return Object.assign(super.toJSON(),{comparePoint:t})}}class Kr extends ne{constructor(t){super(t)}get name(){return"critical-failure"}get notation(){return`cf${super.notation}`}defaultComparePoint(t){return["=",t.min]}run(t,e){return super.run(t,e),t.rolls.forEach(o=>(this.isComparePoint(o.value)&&o.modifiers.add("critical-failure"),o)),t}}C(Kr,"order",10);class Qr extends ne{constructor(t){super(t)}get name(){return"critical-success"}get notation(){return`cs${super.notation}`}defaultComparePoint(t){return["=",t.max]}run(t,e){return super.run(t,e),t.rolls.forEach(o=>(this.isComparePoint(o.value)&&o.modifiers.add("critical-success"),o)),t}}C(Qr,"order",9);const it=Symbol("calculation-value"),Nr=Symbol("is-roll-group"),nt=Symbol("modifiers"),ot=Symbol("results"),Cr=Symbol("use-in-total");class T{constructor(t=[],e=[],o=!1,f=!0){this.isRollGroup=o,this.modifiers=e,this.results=t,this.useInTotal=f}get calculationValue(){return E(this[it])?parseFloat(this[it]):this.value}set calculationValue(t){const e=E(t);if(t===1/0)throw new RangeError("Results calculation value must be a finite number");if(t&&!e)throw new TypeError(`Results calculation value is invalid: ${t}`);this[it]=e?parseFloat(`${t}`):null}get isRollGroup(){return this[Nr]}set isRollGroup(t){this[Nr]=!!t}get length(){return this.results.length||0}get modifierFlags(){return zr(...this.modifiers)}get modifiers(){return this[nt]}set modifiers(t){if((Array.isArray(t)||t instanceof Set)&&[...t].every(e=>typeof e=="string"))this[nt]=new Set([...t]);else if(!t&&t!==0)this[nt]=new Set;else throw new TypeError(`modifiers must be a Set or array of modifier names: ${t}`)}get results(){return[...this[ot]]}set results(t){if(!t||!Array.isArray(t))throw new TypeError(`results must be an array: ${t}`);this[ot]=[],t.forEach(e=>{this.addResult(e)})}get useInTotal(){return!!this[Cr]}set useInTotal(t){this[Cr]=!!t}get value(){if(!this.results.length)return 0;const t=this.results.reduce((e,o)=>{let f=o;return o instanceof T?f=o.useInTotal?o.calculationValue:0:o instanceof k&&(f=o.value),e+f},typeof this.results[0]=="string"?"":0);return typeof t=="string"?Lr(t):t}addResult(t){let e;if(t instanceof T||t instanceof k)e=t;else if(typeof t=="string"||E(t))e=t;else throw new TypeError("value must be one of ResultGroup, RollResults, string, or number");this[ot].push(e)}toJSON(){const{calculationValue:t,isRollGroup:e,modifierFlags:o,modifiers:f,results:u,useInTotal:m,value:$}=this;return{calculationValue:t,isRollGroup:e,modifierFlags:o,modifiers:[...f],results:u,type:"result-group",useInTotal:m,value:$}}toString(){let t;return this.isRollGroup?t=`{${this.results.join(", ")}}`:t=this.results.join(""),this.modifierFlags&&(t=`(${t})${this.modifierFlags}`),t}}const Or=Symbol("end"),Rr=Symbol("qty");class At extends V{constructor(t="h",e=1){super(),this.end=t,this.qty=e}get end(){return this[Or]}set end(t){if(t!=="h"&&t!=="l")throw new RangeError('End must be "h" or "l"');this[Or]=t}get name(){return`keep-${this.end}`}get notation(){return`k${this.end}${this.qty}`}get qty(){return this[Rr]}set qty(t){if(t===1/0)throw new RangeError("qty must be a finite number");if(!E(t)||t<1)throw new TypeError("qty must be a positive finite integer");this[Rr]=Math.floor(t)}rangeToDrop(t){return this.end==="h"?[0,t.length-this.qty]:[this.qty,t.length]}run(t,e){let o,f;return t instanceof T?(o=t.results,o.length===1&&o[0]instanceof T?f=o[0].results.map((u,m)=>u instanceof k?u.rolls.map(($,O)=>({value:$.value,index:[m,O]})):null).flat().filter(Boolean):f=[...o].map((u,m)=>({value:u.value,index:m}))):(o=t.rolls,f=[...o].map((u,m)=>({value:u.value,index:m}))),f=f.sort((u,m)=>u.value-m.value).map(u=>u.index).slice(...this.rangeToDrop(f)),f.forEach(u=>{let m;Array.isArray(u)?m=o[0].results[u[0]].rolls[u[1]]:m=o[u],m.modifiers.add("drop"),m.useInTotal=!1}),t}toJSON(){const{end:t,qty:e}=this;return Object.assign(super.toJSON(),{end:t,qty:e})}}C(At,"order",6);class es extends At{constructor(t="l",e=1){super(t,e)}get name(){return`drop-${this.end}`}get notation(){return`d${this.end}${this.qty}`}rangeToDrop(t){return this.end==="h"?[t.length-this.qty,t.length]:[0,this.qty]}}C(es,"order",7);const Ir=Symbol("compound"),Mr=Symbol("penetrate");class ts extends ne{constructor(t=null,e=!1,o=!1){super(t),this[Ir]=!!e,this[Mr]=!!o}get compound(){return this[Ir]}get name(){return"explode"}get notation(){return`!${this.compound?"!":""}${this.penetrate?"p":""}${super.notation}`}get penetrate(){return this[Mr]}defaultComparePoint(t){return["=",t.max]}run(t,e){if(super.run(t,e),e.min===e.max)throw new ce(e,"explode");const o=t;return o.rolls=t.rolls.map(f=>{const u=[f];let m=f.value;for(let $=0;$<this.maxIterations&&this.isComparePoint(m);$++){const O=u[u.length-1],y=e.rollOnce();m=y.value,O.modifiers.add("explode"),this.penetrate&&(O.modifiers.add("penetrate"),y.value-=1),u.push(y)}return this.compound&&u.length>1?(f.value=Vn(u.map($=>$.value)),f.modifiers=["explode","compound"],this.penetrate&&f.modifiers.add("penetrate"),f):u}).flat(),o}toJSON(){const{compound:t,penetrate:e}=this;return Object.assign(super.toJSON(),{compound:t,penetrate:e})}}C(ts,"order",3);const Fr=Symbol("max");class rs extends V{constructor(t){super(),this.max=t}get max(){return this[Fr]}set max(t){if(!E(t))throw new TypeError("max must be a number");this[Fr]=parseFloat(`${t}`)}get name(){return"max"}get notation(){return`max${this.max}`}run(t,e){const o=t;return o.rolls=t.rolls.map(f=>{const u=f;return f.value>this.max&&(u.value=this.max,u.modifiers.add("max")),u}),o}toJSON(){const{max:t}=this;return Object.assign(super.toJSON(),{max:t})}}C(rs,"order",2);const Pr=Symbol("min");class ss extends V{constructor(t){super(),this.min=t}get min(){return this[Pr]}set min(t){if(!E(t))throw new TypeError("min must be a number");this[Pr]=parseFloat(`${t}`)}get name(){return"min"}get notation(){return`min${this.min}`}run(t,e){const o=t;return o.rolls=t.rolls.map(f=>{const u=f;return f.value<this.min&&(u.value=this.min,u.modifiers.add("min")),u}),o}toJSON(){const{min:t}=this;return Object.assign(super.toJSON(),{min:t})}}C(ss,"order",1);const Jr=Symbol("once");class is extends ne{constructor(t=!1,e=null){super(e),this.once=!!t}get name(){return"re-roll"}get notation(){return`r${this.once?"o":""}${super.notation}`}get once(){return!!this[Jr]}set once(t){this[Jr]=!!t}defaultComparePoint(t){return["=",t.min]}run(t,e){if(super.run(t,e),e.min===e.max)throw new ce(e,"re-roll");return t.rolls.map(o=>{for(let f=0;f<this.maxIterations&&this.isComparePoint(o.value);f++){const u=e.rollOnce();if(o.value=u.value,o.modifiers.add(`re-roll${this.once?"-once":""}`),this.once)break}return o}),t}toJSON(){const{once:t}=this;return Object.assign(super.toJSON(),{once:t})}}C(is,"order",4);const jr=Symbol("direction");class ns extends V{constructor(t="a"){super(),this.direction=t}get direction(){return this[jr]}set direction(t){if(t!=="a"&&t!=="d")throw new RangeError('Direction must be "a" (Ascending) or "d" (Descending)');this[jr]=t}get name(){return"sorting"}get notation(){return`s${this.direction}`}run(t,e){let o;return t instanceof T?o="results":o="rolls",t[o]=t[o].sort((f,u)=>this.direction==="d"?u.value-f.value:f.value-u.value),t instanceof T&&(t[o]=t[o].map(f=>f instanceof T||f instanceof k?this.run(f,e):f)),t}toJSON(){const{direction:t}=this;return Object.assign(super.toJSON(),{direction:t})}}C(ns,"order",11);const kr=Symbol("failure-cp");class os extends ne{constructor(t,e=null){super(t),this.failureComparePoint=e}get failureComparePoint(){return this[kr]}set failureComparePoint(t){if(t&&!(t instanceof je))throw new TypeError("failure comparePoint must be instance of ComparePoint or null");this[kr]=t||null}get name(){return"target"}get notation(){return`${super.notation}${this.failureComparePoint?`f${this.failureComparePoint}`:""}`}get successComparePoint(){return this.comparePoint}set successComparePoint(t){super.comparePoint=t}getStateValue(t){return this.isSuccess(t)?1:this.isFailure(t)?-1:0}isFailure(t){return this.failureComparePoint?this.failureComparePoint.isMatch(t):!1}isNeutral(t){return!this.isSuccess(t)&&!this.isFailure(t)}isSuccess(t){return this.isComparePoint(t)}run(t,e){let o;return t instanceof T?o=t.results:o=t.rolls,o.forEach(f=>{this.isSuccess(f.value)?f.modifiers.add("target-success"):this.isFailure(f.value)&&f.modifiers.add("target-failure"),f.calculationValue=this.getStateValue(f.value)}),t}toJSON(){const{failureComparePoint:t,successComparePoint:e}=this,o=super.toJSON();return delete o.comparePoint,Object.assign(o,{failureComparePoint:t,successComparePoint:e})}}C(os,"order",8);const Dr=Symbol("once"),xo=(s,t,e,o=!1)=>{const f=e.map(u=>u.value).indexOf(s.value);return o?f<t:f!==t};class as extends ne{constructor(t=!1,e=null){super(e),this.once=!!t}get name(){return"unique"}get notation(){return`u${this.once?"o":""}${super.notation}`}get once(){return!!this[Dr]}set once(t){this[Dr]=!!t}run(t,e){if(e.min===e.max)throw new ce(e,"re-roll");return t.rolls.forEach((o,f,u)=>{if(f!==0)for(let m=0;m<this.maxIterations&&(!this.comparePoint||this.isComparePoint(o.value))&&xo(o,f,u,!0);m++){const $=e.rollOnce();if(o.value=$.value,o.modifiers.add(`unique${this.once?"-once":""}`),this.once)break}}),t}toJSON(){const{once:t}=this;return Object.assign(super.toJSON(),{once:t})}}C(as,"order",5);const ls=s=>{try{return!!(s&&btoa(atob(s))===s)}catch{return!1}},fs=s=>{try{const t=s?JSON.parse(s):!1;return!!(t&&typeof t=="object")}catch{return!1}},at=Symbol("expressions"),lt=Symbol("modifiers");class us extends Yr{constructor(t=[],e=[],o=null){super(o),this.expressions=t,this.modifiers=e}get expressions(){return[...this[at]||[]]}set expressions(t){if(!t)throw new I("expressions");if(!Array.isArray(t))throw new TypeError(`expressions must be an array: ${t}`);this[at]=[],t.forEach(e=>{if(!e||!Array.isArray(e))throw new TypeError(`Expressions must be an array of arrays: ${t}`);if(e.length===0)throw new TypeError(`Sub expressions cannot be empty: ${t}`);if(!e.every(o=>o instanceof se||typeof o=="string"||typeof o=="number"))throw new TypeError("Sub expression items must be Dice, numbers, or strings");this[at].push(e)})}get modifiers(){return this[lt]?new Map([...this[lt]].sort((t,e)=>t[1].order-e[1].order)):null}set modifiers(t){let e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map(o=>[o.name,o]));else if(typeof t=="object")e=new Map(Object.entries(t));else throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");if(e.size&&[...e.entries()].some(o=>!(o[1]instanceof V)))throw new TypeError("modifiers must only contain Modifier instances");this[lt]=e}get notation(){let t=this.expressions.map(e=>e.reduce((o,f)=>o+f,"")).join(", ");return t=`{${t}}`,this.modifiers&&this.modifiers.size&&(t+=[...this.modifiers.values()].reduce((e,o)=>e+o.notation,"")),t}roll(){const t=new T(this.expressions.map(e=>{const o=e.map(f=>f instanceof se?f.roll():f);return new T(o)}));return t.isRollGroup=!0,(this.modifiers||[]).forEach(e=>{e.run(t,this)}),t}toJSON(){const{modifiers:t,notation:e,expressions:o}=this;return Object.assign(super.toJSON(),{expressions:o,modifiers:t,notation:e,type:"group"})}toString(){return`${this.notation}${this.description?` ${this.description}`:""}`}}function Eo(s,t){function e(){this.constructor=s}e.prototype=t.prototype,s.prototype=new e}function ie(s,t,e,o){var f=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(f,ie.prototype),f.expected=t,f.found=e,f.location=o,f.name="SyntaxError",f}Eo(ie,Error);function ft(s,t,e){return e=e||" ",s.length>t?s:(t-=s.length,e+=e.repeat(t),s+e.slice(0,t))}ie.prototype.format=function(s){var t="Error: "+this.message;if(this.location){var e=null,o;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){e=s[o].text.split(/\r\n|\n|\r/g);break}var f=this.location.start,u=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(f):f,m=this.location.source+":"+u.line+":"+u.column;if(e){var $=this.location.end,O=ft("",u.line.toString().length," "),y=e[f.line-1],v=f.line===$.line?$.column:y.length+1,N=v-f.column||1;t+=`
 --> `+m+`
`+O+` |
`+u.line+" | "+y+`
`+O+" | "+ft("",f.column-1," ")+ft("",N,"^")}else t+=`
 at `+m}return t};ie.buildMessage=function(s,t){var e={literal:function(y){return'"'+f(y.text)+'"'},class:function(y){var v=y.parts.map(function(N){return Array.isArray(N)?u(N[0])+"-"+u(N[1]):u(N)});return"["+(y.inverted?"^":"")+v.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(y){return y.description}};function o(y){return y.charCodeAt(0).toString(16).toUpperCase()}function f(y){return y.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(v){return"\\x0"+o(v)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(v){return"\\x"+o(v)})}function u(y){return y.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(v){return"\\x0"+o(v)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(v){return"\\x"+o(v)})}function m(y){return e[y.type](y)}function $(y){var v=y.map(m),N,H;if(v.sort(),v.length>0){for(N=1,H=1;N<v.length;N++)v[N-1]!==v[N]&&(v[H]=v[N],H++);v.length=H}switch(v.length){case 1:return v[0];case 2:return v[0]+" or "+v[1];default:return v.slice(0,-1).join(", ")+", or "+v[v.length-1]}}function O(y){return y?'"'+f(y)+'"':"end of input"}return"Expected "+$(s)+" but "+O(t)+" found."};function Ao(s,t){t=t!==void 0?t:{};var e={},o=t.grammarSource,f={Main:or},u=or,m="{",$=",",O="}",y="d",v="d%",N="dF",H=".",Tt="!",hs="p",ps="k",pe="max",ge="min",gs="r",Nt="o",ms="u",Ct="cs",Ot="cf",ds="s",$s="a",ys="f",Rt="!=",It="<=",Mt=">=",bs="=",Ft="<>",vs=">",ws="<",me="(",de=")",Pt="abs",Jt="ceil",jt="cos",kt="exp",Dt="floor",Vt="log",qt="round",Lt="sign",Bt="sin",Ut="sqrt",Gt="tan",_t="pow",Ss="-",Wt="**",xs="*",Es="^",As="%",Ts="/",Ns="+",Zt="/*",Y="*/",Cs="[",Os="]",Xt="//",Rs="#",Is=/^[12]/,Ht=/^[lh]/,Ms=/^[.]/,Fs=/^[1-9]/,$e=/^[0-9]/,Yt=/^[^\]]/,Ps=/^[\n\r\u2028\u2029]/,Js=/^[ \t\n\r]/,js=d("{",!1),Ve=d(",",!1),ks=d("}",!1),qe=d("d",!1),Ds=d("d%",!1),Vs=d("dF",!1),qs=d(".",!1),Ls=q(["1","2"],!1,!1),zt=d("!",!1),Bs=d("p",!1),Kt=q(["l","h"],!1,!1),Us=d("k",!1),Qt=d("max",!1),er=d("min",!1),Gs=d("r",!1),tr=d("o",!1),_s=d("u",!1),Ws=d("cs",!1),Zs=d("cf",!1),Xs=d("s",!1),Hs=d("a",!1),Ys=d("f",!1),zs=d("!=",!1),Ks=d("<=",!1),Qs=d(">=",!1),ei=d("=",!1),ti=d("<>",!1),ri=d(">",!1),si=d("<",!1),ye=d("(",!1),be=d(")",!1),ii=d("abs",!1),ni=d("ceil",!1),oi=d("cos",!1),ai=d("exp",!1),li=d("floor",!1),fi=d("log",!1),ui=d("round",!1),ci=d("sign",!1),hi=d("sin",!1),pi=d("sqrt",!1),gi=d("tan",!1),mi=d("pow",!1),rr=d("-",!1),di=q(["."],!1,!1),$i=q([["1","9"]],!1,!1),ve=q([["0","9"]],!1,!1),yi=d("**",!1),bi=d("*",!1),vi=d("^",!1),wi=d("%",!1),Si=d("/",!1),xi=d("+",!1),Ei=Ue("comment"),Ai=d("/*",!1),Le=d("*/",!1),we=cn(),Ti=d("[",!1),sr=q(["]"],!0,!1),Ni=d("]",!1),Ci=d("//",!1),Oi=d("#",!1),Ri=q([`
`,"\r","\u2028","\u2029"],!1,!1),Ii=Ue("whitespace"),Mi=q([" ","	",`
`,"\r"],!1,!1),Fi=Ue("whitespace or comment"),Pi=function(r,n,a,l){return new us([r,...n.map(h=>h[3])],Object.assign({},...a.map(h=>({[h.name]:h}))),l.find(h=>h instanceof P))},Ji=function(r,n,a){return r.modifiers=Object.assign({},...n.map(l=>({[l.name]:l}))),r.description=a.find(l=>l instanceof P),r},ji=function(r,n){return new se(n,r||1)},ki=function(r){return new So(r||1)},Di=function(r,n){return new wo(n?parseInt(n[1],10):2,r||1)},Vi=function(r,n,a){return new ts(a,!!r,!!n)},qi=function(r,n){return new os(r,n)},Li=function(r,n){return new es(r||"l",n)},Bi=function(r,n){return new At(r||"h",n)},Ui=function(r){return new rs(r)},Gi=function(r){return new ss(r)},_i=function(r,n){return new is(!!r,n)},Wi=function(r,n){return new as(!!r,n)},Zi=function(r){return new Qr(r)},Xi=function(r){return new Kr(r)},Hi=function(r){return new ns(r||"a")},Yi=function(r){return r},zi=function(r,n){return new je(r,n)},Ki=function(r,n,a){return Lr(Ee())},Qi=function(r,n){return r=Array.isArray(r)?r:[r],[...r,...n.map(([,a,,l])=>[a,l]).flat(2)]},en=function(r,n,a){return[r,...n,a]},tn=function(r,n){return[`${r}(`,...n,")"]},rn=function(r,n,a){return[`${r}(`,...n,",",...a,")"]},sn=function(){return parseFloat(Ee())},nn=function(){return parseInt(Ee(),10)},on=function(){return parseInt(Ee(),10)},an=function(){return"^"},ln=function(r){return new P(r.flat().join(""),P.types.MULTILINE)},fn=function(r){return new P(r.flat().join(""),P.types.MULTILINE)},un=function(r){return new P(r.flat().join(""),P.types.INLINE)},i=0,b=0,Se=[{line:1,column:1}],J=0,Be=[],c=0,xe;if("startRule"in t){if(!(t.startRule in f))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');u=f[t.startRule]}function Ee(){return s.substring(b,i)}function d(r,n){return{type:"literal",text:r,ignoreCase:n}}function q(r,n,a){return{type:"class",parts:r,inverted:n,ignoreCase:a}}function cn(){return{type:"any"}}function hn(){return{type:"end"}}function Ue(r){return{type:"other",description:r}}function ir(r){var n=Se[r],a;if(n)return n;for(a=r-1;!Se[a];)a--;for(n=Se[a],n={line:n.line,column:n.column};a<r;)s.charCodeAt(a)===10?(n.line++,n.column=1):n.column++,a++;return Se[r]=n,n}function nr(r,n,a){var l=ir(r),h=ir(n),g={source:o,start:{offset:r,line:l.line,column:l.column},end:{offset:n,line:h.line,column:h.column}};return g}function p(r){i<J||(i>J&&(J=i,Be=[]),Be.push(r))}function pn(r,n,a){return new ie(ie.buildMessage(r,n),r,n,a)}function or(){var r;return r=L(),r}function gn(){var r,n,a,l,h,g,w,x,F;if(r=i,s.charCodeAt(i)===123?(n=m,i++):(n=e,c===0&&p(js)),n!==e)if(S(),a=L(),a!==e){for(l=[],h=i,g=S(),s.charCodeAt(i)===44?(w=$,i++):(w=e,c===0&&p(Ve)),w!==e?(x=S(),F=L(),F!==e?(g=[g,w,x,F],h=g):(i=h,h=e)):(i=h,h=e);h!==e;)l.push(h),h=i,g=S(),s.charCodeAt(i)===44?(w=$,i++):(w=e,c===0&&p(Ve)),w!==e?(x=S(),F=L(),F!==e?(g=[g,w,x,F],h=g):(i=h,h=e)):(i=h,h=e);if(h=S(),s.charCodeAt(i)===125?(g=O,i++):(g=e,c===0&&p(ks)),g!==e){for(w=[],x=Ae();x!==e;)w.push(x),x=Ae();x=ur(),b=r,r=Pi(a,l,w,x)}else i=r,r=e}else i=r,r=e;else i=r,r=e;return r}function mn(){var r,n,a,l;if(r=i,n=dn(),n===e&&(n=$n(),n===e&&(n=yn())),n!==e){for(a=[],l=Ae();l!==e;)a.push(l),l=Ae();l=ur(),b=r,r=Ji(n,a,l)}else i=r,r=e;return r}function dn(){var r,n,a,l;return r=i,n=Te(),n===e&&(n=null),s.charCodeAt(i)===100?(a=y,i++):(a=e,c===0&&p(qe)),a!==e?(l=Te(),l!==e?(b=r,r=ji(n,l)):(i=r,r=e)):(i=r,r=e),r}function $n(){var r,n,a;return r=i,n=Te(),n===e&&(n=null),s.substr(i,2)===v?(a=v,i+=2):(a=e,c===0&&p(Ds)),a!==e?(b=r,r=ki(n)):(i=r,r=e),r}function yn(){var r,n,a,l,h,g;return r=i,n=Te(),n===e&&(n=null),s.substr(i,2)===N?(a=N,i+=2):(a=e,c===0&&p(Vs)),a!==e?(l=i,s.charCodeAt(i)===46?(h=H,i++):(h=e,c===0&&p(qs)),h!==e?(Is.test(s.charAt(i))?(g=s.charAt(i),i++):(g=e,c===0&&p(Ls)),g!==e?(h=[h,g],l=h):(i=l,l=e)):(i=l,l=e),l===e&&(l=null),b=r,r=Di(n,l)):(i=r,r=e),r}function Ae(){var r;return r=bn(),r===e&&(r=vn(),r===e&&(r=wn(),r===e&&(r=Sn(),r===e&&(r=An(),r===e&&(r=Tn(),r===e&&(r=Nn(),r===e&&(r=Cn(),r===e&&(r=On(),r===e&&(r=xn(),r===e&&(r=En())))))))))),r}function bn(){var r,n,a,l,h;return r=i,s.charCodeAt(i)===33?(n=Tt,i++):(n=e,c===0&&p(zt)),n!==e?(s.charCodeAt(i)===33?(a=Tt,i++):(a=e,c===0&&p(zt)),a===e&&(a=null),s.charCodeAt(i)===112?(l=hs,i++):(l=e,c===0&&p(Bs)),l===e&&(l=null),h=_(),h===e&&(h=null),b=r,r=Vi(a,l,h)):(i=r,r=e),r}function vn(){var r,n,a;return r=i,n=_(),n!==e?(a=Rn(),a===e&&(a=null),b=r,r=qi(n,a)):(i=r,r=e),r}function wn(){var r,n,a,l;return r=i,s.charCodeAt(i)===100?(n=y,i++):(n=e,c===0&&p(qe)),n!==e?(Ht.test(s.charAt(i))?(a=s.charAt(i),i++):(a=e,c===0&&p(Kt)),a===e&&(a=null),l=_e(),l!==e?(b=r,r=Li(a,l)):(i=r,r=e)):(i=r,r=e),r}function Sn(){var r,n,a,l;return r=i,s.charCodeAt(i)===107?(n=ps,i++):(n=e,c===0&&p(Us)),n!==e?(Ht.test(s.charAt(i))?(a=s.charAt(i),i++):(a=e,c===0&&p(Kt)),a===e&&(a=null),l=_e(),l!==e?(b=r,r=Bi(a,l)):(i=r,r=e)):(i=r,r=e),r}function xn(){var r,n,a;return r=i,s.substr(i,3)===pe?(n=pe,i+=3):(n=e,c===0&&p(Qt)),n!==e?(a=W(),a!==e?(b=r,r=Ui(a)):(i=r,r=e)):(i=r,r=e),r}function En(){var r,n,a;return r=i,s.substr(i,3)===ge?(n=ge,i+=3):(n=e,c===0&&p(er)),n!==e?(a=W(),a!==e?(b=r,r=Gi(a)):(i=r,r=e)):(i=r,r=e),r}function An(){var r,n,a,l;return r=i,s.charCodeAt(i)===114?(n=gs,i++):(n=e,c===0&&p(Gs)),n!==e?(s.charCodeAt(i)===111?(a=Nt,i++):(a=e,c===0&&p(tr)),a===e&&(a=null),l=_(),l===e&&(l=null),b=r,r=_i(a,l)):(i=r,r=e),r}function Tn(){var r,n,a,l;return r=i,s.charCodeAt(i)===117?(n=ms,i++):(n=e,c===0&&p(_s)),n!==e?(s.charCodeAt(i)===111?(a=Nt,i++):(a=e,c===0&&p(tr)),a===e&&(a=null),l=_(),l===e&&(l=null),b=r,r=Wi(a,l)):(i=r,r=e),r}function Nn(){var r,n,a;return r=i,s.substr(i,2)===Ct?(n=Ct,i+=2):(n=e,c===0&&p(Ws)),n!==e?(a=_(),a===e&&(a=null),b=r,r=Zi(a)):(i=r,r=e),r}function Cn(){var r,n,a;return r=i,s.substr(i,2)===Ot?(n=Ot,i+=2):(n=e,c===0&&p(Zs)),n!==e?(a=_(),a===e&&(a=null),b=r,r=Xi(a)):(i=r,r=e),r}function On(){var r,n,a;return r=i,s.charCodeAt(i)===115?(n=ds,i++):(n=e,c===0&&p(Xs)),n!==e?(s.charCodeAt(i)===97?(a=$s,i++):(a=e,c===0&&p(Hs)),a===e&&(s.charCodeAt(i)===100?(a=y,i++):(a=e,c===0&&p(qe))),a===e&&(a=null),b=r,r=Hi(a)):(i=r,r=e),r}function Rn(){var r,n,a;return r=i,s.charCodeAt(i)===102?(n=ys,i++):(n=e,c===0&&p(Ys)),n!==e?(a=_(),a!==e?(b=r,r=Yi(a)):(i=r,r=e)):(i=r,r=e),r}function _(){var r,n,a;return r=i,n=In(),n!==e?(a=W(),a!==e?(b=r,r=zi(n,a)):(i=r,r=e)):(i=r,r=e),r}function In(){var r;return s.substr(i,2)===Rt?(r=Rt,i+=2):(r=e,c===0&&p(zs)),r===e&&(s.substr(i,2)===It?(r=It,i+=2):(r=e,c===0&&p(Ks)),r===e&&(s.substr(i,2)===Mt?(r=Mt,i+=2):(r=e,c===0&&p(Qs)),r===e&&(s.charCodeAt(i)===61?(r=bs,i++):(r=e,c===0&&p(ei)),r===e&&(s.substr(i,2)===Ft?(r=Ft,i+=2):(r=e,c===0&&p(ti)),r===e&&(s.charCodeAt(i)===62?(r=vs,i++):(r=e,c===0&&p(ri)),r===e&&(s.charCodeAt(i)===60?(r=ws,i++):(r=e,c===0&&p(si)))))))),r}function Te(){var r,n,a,l,h,g,w,x,F,z;if(r=_e(),r===e)if(r=i,s.charCodeAt(i)===40?(n=me,i++):(n=e,c===0&&p(ye)),n!==e){if(S(),a=i,l=W(),l!==e){if(h=[],g=i,w=S(),x=Ne(),x!==e?(F=S(),z=W(),z!==e?(w=[w,x,F,z],g=w):(i=g,g=e)):(i=g,g=e),g!==e)for(;g!==e;)h.push(g),g=i,w=S(),x=Ne(),x!==e?(F=S(),z=W(),z!==e?(w=[w,x,F,z],g=w):(i=g,g=e)):(i=g,g=e);else h=e;h!==e?(l=[l,h],a=l):(i=a,a=e)}else i=a,a=e;a!==e?(l=S(),s.charCodeAt(i)===41?(h=de,i++):(h=e,c===0&&p(be)),h!==e?(b=r,r=Ki()):(i=r,r=e)):(i=r,r=e)}else i=r,r=e;return r}function L(){var r,n,a,l,h,g,w,x;if(r=i,n=Ge(),n!==e){for(a=[],l=i,h=S(),g=Ne(),g!==e?(w=S(),x=Ge(),x!==e?(h=[h,g,w,x],l=h):(i=l,l=e)):(i=l,l=e);l!==e;)a.push(l),l=i,h=S(),g=Ne(),g!==e?(w=S(),x=Ge(),x!==e?(h=[h,g,w,x],l=h):(i=l,l=e)):(i=l,l=e);b=r,r=Qi(n,a)}else i=r,r=e;return r}function Ge(){var r,n,a,l;return r=Mn(),r===e&&(r=mn(),r===e&&(r=W(),r===e&&(r=i,s.charCodeAt(i)===40?(n=me,i++):(n=e,c===0&&p(ye)),n!==e?(S(),a=L(),a!==e?(S(),s.charCodeAt(i)===41?(l=de,i++):(l=e,c===0&&p(be)),l!==e?(b=r,r=en(n,a,l)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e),r===e&&(r=gn())))),r}function Mn(){var r,n,a,l,h,g,w;return r=i,s.substr(i,3)===Pt?(n=Pt,i+=3):(n=e,c===0&&p(ii)),n===e&&(s.substr(i,4)===Jt?(n=Jt,i+=4):(n=e,c===0&&p(ni)),n===e&&(s.substr(i,3)===jt?(n=jt,i+=3):(n=e,c===0&&p(oi)),n===e&&(s.substr(i,3)===kt?(n=kt,i+=3):(n=e,c===0&&p(ai)),n===e&&(s.substr(i,5)===Dt?(n=Dt,i+=5):(n=e,c===0&&p(li)),n===e&&(s.substr(i,3)===Vt?(n=Vt,i+=3):(n=e,c===0&&p(fi)),n===e&&(s.substr(i,5)===qt?(n=qt,i+=5):(n=e,c===0&&p(ui)),n===e&&(s.substr(i,4)===Lt?(n=Lt,i+=4):(n=e,c===0&&p(ci)),n===e&&(s.substr(i,3)===Bt?(n=Bt,i+=3):(n=e,c===0&&p(hi)),n===e&&(s.substr(i,4)===Ut?(n=Ut,i+=4):(n=e,c===0&&p(pi)),n===e&&(s.substr(i,3)===Gt?(n=Gt,i+=3):(n=e,c===0&&p(gi)))))))))))),n!==e?(s.charCodeAt(i)===40?(a=me,i++):(a=e,c===0&&p(ye)),a!==e?(S(),l=L(),l!==e?(S(),s.charCodeAt(i)===41?(h=de,i++):(h=e,c===0&&p(be)),h!==e?(b=r,r=tn(n,l)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e),r===e&&(r=i,s.substr(i,3)===_t?(n=_t,i+=3):(n=e,c===0&&p(mi)),n===e&&(s.substr(i,3)===pe?(n=pe,i+=3):(n=e,c===0&&p(Qt)),n===e&&(s.substr(i,3)===ge?(n=ge,i+=3):(n=e,c===0&&p(er)))),n!==e?(s.charCodeAt(i)===40?(a=me,i++):(a=e,c===0&&p(ye)),a!==e?(S(),l=L(),l!==e?(S(),s.charCodeAt(i)===44?(h=$,i++):(h=e,c===0&&p(Ve)),h!==e?(S(),g=L(),g!==e?(S(),s.charCodeAt(i)===41?(w=de,i++):(w=e,c===0&&p(be)),w!==e?(b=r,r=rn(n,l,g)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e)):(i=r,r=e)),r}function W(){var r,n,a,l,h;return r=i,s.charCodeAt(i)===45?i++:c===0&&p(rr),n=ar(),n!==e?(a=i,Ms.test(s.charAt(i))?(l=s.charAt(i),i++):(l=e,c===0&&p(di)),l!==e?(h=ar(),h!==e?(l=[l,h],a=l):(i=a,a=e)):(i=a,a=e),a===e&&(a=null),b=r,r=sn()):(i=r,r=e),r}function _e(){var r,n,a,l;if(r=i,Fs.test(s.charAt(i))?(n=s.charAt(i),i++):(n=e,c===0&&p($i)),n!==e){for(a=[],$e.test(s.charAt(i))?(l=s.charAt(i),i++):(l=e,c===0&&p(ve));l!==e;)a.push(l),$e.test(s.charAt(i))?(l=s.charAt(i),i++):(l=e,c===0&&p(ve));b=r,r=nn()}else i=r,r=e;return r}function ar(){var r,n,a;if(r=i,n=[],$e.test(s.charAt(i))?(a=s.charAt(i),i++):(a=e,c===0&&p(ve)),a!==e)for(;a!==e;)n.push(a),$e.test(s.charAt(i))?(a=s.charAt(i),i++):(a=e,c===0&&p(ve));else n=e;return n!==e&&(b=r,n=on()),r=n,r}function Ne(){var r,n;return r=i,s.substr(i,2)===Wt?(n=Wt,i+=2):(n=e,c===0&&p(yi)),n!==e&&(b=r,n=an()),r=n,r===e&&(s.charCodeAt(i)===42?(r=xs,i++):(r=e,c===0&&p(bi)),r===e&&(s.charCodeAt(i)===94?(r=Es,i++):(r=e,c===0&&p(vi)),r===e&&(s.charCodeAt(i)===37?(r=As,i++):(r=e,c===0&&p(wi)),r===e&&(s.charCodeAt(i)===47?(r=Ts,i++):(r=e,c===0&&p(Si)),r===e&&(s.charCodeAt(i)===43?(r=Ns,i++):(r=e,c===0&&p(xi)),r===e&&(s.charCodeAt(i)===45?(r=Ss,i++):(r=e,c===0&&p(rr)))))))),r}function lr(){var r;return c++,r=Fn(),r===e&&(r=Pn()),c--,r===e&&c===0&&p(Ei),r}function Fn(){var r,n,a,l,h,g;if(r=i,s.substr(i,2)===Zt?(n=Zt,i+=2):(n=e,c===0&&p(Ai)),n!==e){for(a=[],l=i,h=i,c++,s.substr(i,2)===Y?(g=Y,i+=2):(g=e,c===0&&p(Le)),c--,g===e?h=void 0:(i=h,h=e),h!==e?(s.length>i?(g=s.charAt(i),i++):(g=e,c===0&&p(we)),g!==e?(h=[h,g],l=h):(i=l,l=e)):(i=l,l=e);l!==e;)a.push(l),l=i,h=i,c++,s.substr(i,2)===Y?(g=Y,i+=2):(g=e,c===0&&p(Le)),c--,g===e?h=void 0:(i=h,h=e),h!==e?(s.length>i?(g=s.charAt(i),i++):(g=e,c===0&&p(we)),g!==e?(h=[h,g],l=h):(i=l,l=e)):(i=l,l=e);s.substr(i,2)===Y?(l=Y,i+=2):(l=e,c===0&&p(Le)),l!==e?(b=r,r=ln(a)):(i=r,r=e)}else i=r,r=e;if(r===e)if(r=i,s.charCodeAt(i)===91?(n=Cs,i++):(n=e,c===0&&p(Ti)),n!==e){for(a=[],Yt.test(s.charAt(i))?(l=s.charAt(i),i++):(l=e,c===0&&p(sr));l!==e;)a.push(l),Yt.test(s.charAt(i))?(l=s.charAt(i),i++):(l=e,c===0&&p(sr));s.charCodeAt(i)===93?(l=Os,i++):(l=e,c===0&&p(Ni)),l!==e?(b=r,r=fn(a)):(i=r,r=e)}else i=r,r=e;return r}function Pn(){var r,n,a,l,h,g;if(r=i,s.substr(i,2)===Xt?(n=Xt,i+=2):(n=e,c===0&&p(Ci)),n===e&&(s.charCodeAt(i)===35?(n=Rs,i++):(n=e,c===0&&p(Oi))),n!==e){for(a=[],l=i,h=i,c++,g=fr(),c--,g===e?h=void 0:(i=h,h=e),h!==e?(s.length>i?(g=s.charAt(i),i++):(g=e,c===0&&p(we)),g!==e?(h=[h,g],l=h):(i=l,l=e)):(i=l,l=e);l!==e;)a.push(l),l=i,h=i,c++,g=fr(),c--,g===e?h=void 0:(i=h,h=e),h!==e?(s.length>i?(g=s.charAt(i),i++):(g=e,c===0&&p(we)),g!==e?(h=[h,g],l=h):(i=l,l=e)):(i=l,l=e);b=r,r=un(a)}else i=r,r=e;return r}function fr(){var r;return Ps.test(s.charAt(i))?(r=s.charAt(i),i++):(r=e,c===0&&p(Ri)),r}function Ce(){var r;return c++,Js.test(s.charAt(i))?(r=s.charAt(i),i++):(r=e,c===0&&p(Mi)),c--,r===e&&c===0&&p(Ii),r}function S(){var r,n;for(r=[],n=Ce();n!==e;)r.push(n),n=Ce();return r}function ur(){var r,n;for(c++,r=[],n=Ce(),n===e&&(n=lr());n!==e;)r.push(n),n=Ce(),n===e&&(n=lr());return c--,n=e,c===0&&p(Fi),r}if(xe=u(),xe!==e&&i===s.length)return xe;throw xe!==e&&i<s.length&&p(hn()),pn(Be,J<s.length?s.charAt(J):null,J<s.length?nr(J,J+1):nr(J,J))}class Vr{static parse(t){if(!t)throw new I("notation");if(typeof t!="string")throw new TypeError("Notation must be a string");return Ao(t)}}const R=Object.freeze({BASE_64:1,JSON:0,OBJECT:2}),ut=Symbol("notation"),ct=Symbol("maxTotal"),ht=Symbol("minTotal"),Q=Symbol("expressions"),Ie=Symbol("roll-method"),B=Symbol("rolls"),qr=Symbol("set-rolls"),Me=Symbol("total"),pt=s=>qn(s.calculationValue,2);class re{constructor(t){if(!t)throw new I("notation");if(this[Q]=[],t instanceof Object&&!Array.isArray(t)){if(t.notation){if(typeof t.notation!="string")throw new Fe(t.notation);t.rolls&&this[qr](t.rolls)}else throw new I("notation");this[ut]=t.notation,this[Q]=Vr.parse(this.notation),this.hasRolls()||this.roll()}else if(typeof t=="string")this[ut]=t,this[Q]=Vr.parse(this.notation),this.roll();else throw new Fe(t)}get averageTotal(){return(this.maxTotal+this.minTotal)/2}get maxTotal(){if(!this.hasExpressions())return 0;if(!this[ct]){const t=this[Ie](dr.max);this[ct]=pt(t)}return this[ct]}get minTotal(){if(!this.hasExpressions())return 0;if(!this[ht]){const t=this[Ie](dr.min);this[ht]=pt(t)}return this[ht]}get notation(){return this[ut]}get output(){let t=`${this.notation}: `;return this.hasRolls()?t+=`${this[B]} = ${this.total}`:t+="No dice rolled",t}get rolls(){return this[B]?this[B].results:[]}get total(){return!this[Me]&&this.hasRolls()&&(this[Me]=pt(this[B])),this[Me]||0}export(t=R.JSON){switch(t){case R.BASE_64:return btoa(this.export(R.JSON));case R.JSON:return JSON.stringify(this);case R.OBJECT:return JSON.parse(this.export(R.JSON));default:throw new TypeError(`Invalid export format "${t}"`)}}hasExpressions(){return this[Q]&&this[Q].length>0}hasRolls(){return this.hasExpressions()&&this.rolls.length>0}roll(){return this[Me]=0,this[B]=this[Ie](),this.rolls}toJSON(){const{averageTotal:t,maxTotal:e,minTotal:o,notation:f,output:u,rolls:m,total:$}=this;return{averageTotal:t,maxTotal:e,minTotal:o,notation:f,output:u,rolls:m,total:$,type:"dice-roll"}}toString(){return this.output}static import(t){if(t){if(fs(t))return re.import(JSON.parse(t));if(ls(t))return re.import(atob(t));if(typeof t=="object")return new re(t);throw new ke(t)}else throw new I("data")}[Ie](t){let e;t&&(e=te.engine,te.engine=t);const o=new T(this[Q].map(f=>f instanceof se||f instanceof us?f.roll():f).filter(f=>!!f||f===0));return t&&(te.engine=e),o}[qr](t){if(t instanceof T)this[B]=t;else if(t instanceof k)this[B]=new T([t]);else if(Array.isArray(t))this[B]=new T(t.map(e=>{if(e instanceof T||e instanceof k)return e;if(Array.isArray(e))return new k(e);if(typeof e=="object"){if(Array.isArray(e.results))return new T(e.results,e.modifiers||[],e.isRollGroup||!1,typeof e.useInTotal=="boolean"?e.useInTotal:!0);if(Array.isArray(e.rolls))return new k(e.rolls)}return e}));else throw new TypeError("Rolls must be a valid result object, or an array")}}const fe=Symbol("log");class cs{constructor(t){this[fe]=[],t&&this.import(t)}get log(){return this[fe]||[]}get output(){return this.log.join("; ")}get total(){return this.log.reduce((t,e)=>t+e.total,0)}clearLog(){this[fe].length=0}export(t=R.JSON){switch(t){case R.BASE_64:return btoa(this.export(R.JSON));case R.JSON:return JSON.stringify(this);case R.OBJECT:return JSON.parse(this.export(R.JSON));default:throw new TypeError(`Invalid export format "${t}"`)}}import(t){if(t){if(fs(t))return this.import(JSON.parse(t));if(ls(t))return this.import(atob(t));if(typeof t=="object"){let e=t.log||null;if(!t.log&&Array.isArray(t)&&t.length&&(e=t),e&&Array.isArray(e))e.forEach(o=>{this[fe].push(re.import(o))});else if(e)throw new TypeError("log must be an array");return this.log}else throw new ke(t)}else throw new I("data")}roll(...t){const e=t.filter(Boolean);if(e.length===0)throw new I("notations");const o=e.map(f=>{const u=new re(f);return this[fe].push(u),u});return o.length>1?o:o[0]}toJSON(){const{log:t,output:e,total:o}=this;return{log:t,output:e,total:o,type:"dice-roller"}}toString(){return this.output}static import(t){const e=new cs;return e.import(t),e}}export{cs as D};
